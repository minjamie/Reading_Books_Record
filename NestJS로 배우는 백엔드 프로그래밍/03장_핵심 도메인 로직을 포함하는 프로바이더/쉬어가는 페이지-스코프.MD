# ì‰¬ì–´ê°€ëŠ” í˜ì´ì§€ - ìŠ¤ì½”í”„(Scope)

---

- Node.jsëŠ” ë‹¤ë¥¸ ì›¹ í”„ë ˆì„ì›Œí¬ì™€ëŠ” ë‹¤ë¥´ê²Œ ë©€í‹° ì“°ë ˆë“œ ìƒíƒœ ë¹„ì €ì¥(Multi-Threaded Stateless) ëª¨ë¸ì„ ë”°ë¥´ì§€ ì•ŠìŒ
  -> ë”°ë¼ì„œ ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì•ˆì „í•œ ë°©ì‹
  -> ì´ëŠ” ìš”ì²­ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ëª¨ë“  ì •ë³´(DB ì»¤ë„¥ì…˜ í’€, ì „ì—­ ì‹±ê¸€í†¤ ì„œë¹„ìŠ¤ ë“±)ë“¤ì„ ê³µìœ í•  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸

í•˜ì§€ë§Œ GraphQL ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ìš”ì²­ë³„ ìºì‹±ì„ í•œë‹¤ê±°ë‚˜ ìš”ì²­ì„ ì¶”ì í•˜ê±°ë‚˜ ë˜ëŠ” ë©€í‹°í…Œë„Œì‹œë¥¼ ì§€ì›í•˜ê¸° ìœ„í•´ì„œëŠ” ìš”ì²­ ê¸°ë°˜ìœ¼ë¡œ ìƒëª… ì£¼ê¸°ë¥¼ ì œí•œ

ğŸ’¡ ë©€í‹° í…Œë„Œì‹œë€?

> - í•˜ë‚˜ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—¬ëŸ¬ ì‚¬ìš©ìì—ê²Œ ê°ê° ë‹¤ë¥´ê²Œ ë™ì‘í•˜ë„ë¡ í•˜ëŠ” SW ì•„í‚¤í…ì²˜
> - ë°˜ëŒ€ë¡œ ê° ì‚¬ìš©ìë§ˆë‹¤ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒˆë¡œ ë§Œë“¤ì–´ ì§€ë„ë¡ í•˜ëŠ” ë©€í‹° ì¸ìŠ¤í„´ìŠ¤ ë°©ì‹ì´ ìˆëŠ”ë° ìš”ì¦˜ ëŒ€ë¶€ë¶„ì˜ ì„œë¹„ìŠ¤ëŠ” ë©€í‹° í…Œë„Œì‹œ ë°©ì‹ì„ ì±„íƒí•˜ê³  ìˆìŒ

- ì»¨íŠ¸ë¡¤ëŸ¬ì™€ í”„ë¡œë°”ì´ë”ì— ìƒëª… ì£¼ê¸°ë¥¼ ìŠ¤ì½”í”„ ì˜µì…˜ì„ ì£¼ì–´ ì§€ì •í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ìˆìŒ

#### ìŠ¤ì½”í”„ì˜ ì¢…ë¥˜

> `DEFAULT` : ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤ê°€ ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ê³µìœ  - ì¸ìŠ¤í„´ìŠ¤ ìˆ˜ëª…ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜ëª…ì£¼ê¸°ì™€ ê°™ìŒ.

- ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë¶€íŠ¸ìŠ¤íŠ¸ë©(ì• í”Œë¦¬ì¼€ì´ì…˜ ë˜ëŠ” ì‹œìŠ¤í…œì´ êµ¬ë™ë˜ëŠ” ê²ƒ) ê³¼ì •ì„ ë§ˆì¹˜ë©´ ëª¨ë“  ì‹±ê¸€í†¤ í”„ë¡œë°”ì´ë”ì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ë§Œë“¤ì–´ì§
- ë”°ë¡œ ì„ ì–¸í•˜ì§€ ì•Šìœ¼ë©´ DEFAULTê°€ ì ìš©

> `REQUEST` : ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ë§ˆë‹¤ ë³„ë„ì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±
>
> - ìš”ì²­ì„ ì²˜ë¦¬í•˜ê³  ë‚˜ë©´ ì¸ìŠ¤í„´ìŠ¤ëŠ” ì“°ë ˆê¸° ìˆ˜ì§‘(garbage-collected)ëŒ

> `TRANSIENT` : ì´ ìŠ¤ì½”í”„ë¥¼ ì§€ì •í•œ ì¸ìŠ¤í„´ìŠ¤ëŠ” ê³µìœ ë˜ì§€ ì•ŠìŒ
>
> - ì„ì‹œ(TRANSIENT) í”„ë¡œë°”ì´ë”ë¥¼ ì£¼ì…í•˜ëŠ” ê° ì»´í¬ë„ŒíŠ¸ëŠ” ìƒˆë¡œ ìƒì„±ëœ ì „ìš© ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì£¼ì…ë°›ê²Œ ëŒ

> ğŸ’¡) ê°€ëŠ¥í•˜ë©´ `DEFAULT` ìŠ¤ì½”í”„ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥!
> => ì‹±ê¸€í†¤ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê³µìœ í•œë‹¤ëŠ” ê²ƒì€ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìºì‹œí•  ìˆ˜ ìˆê³ , ì´ˆê¸°í™”ê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ì¤‘ì— í•œë²ˆë§Œ ë°œìƒí•˜ë¯€ë¡œ ë©”ëª¨ë¦¬ì™€ ë™ì‘ ì„±ëŠ¥ì„ í–¥ìƒ ê°€ëŠ¥

#### í”„ë¡œë°”ì´ë”ì— ìŠ¤ì½”í”„ ì ìš©

> @Injectable() ë°ì½”ë ˆì´í„°ì— scope ì†ì„±ì„ ì£¼ëŠ” ë°©ë²•

```js
import { Injectable, Scope } from "@nestjs/common";

@Injectable({ scope: Scope.REQUEST })
export class CatsService {}
```

- ì»¤ìŠ¤í…€ í”„ë¡œë°”ì´ë”ë¥¼ ì‚¬ìš©í•  ë•Œ ì—­ì‹œ ë™ì¼

```js
{
provide: 'CACHE_MANAGER',
useClass: CacheManager,
scope: Scope.TRANSIENT,
}
```

#### ì»¨íŠ¸ë¡¤ëŸ¬ì— ìŠ¤ì½”í”„ ì ìš©í•˜ê¸°

- @Controller() ë°ì½”ë ˆì´í„°ëŠ” ControllerOptionsì„ ì¸ìë¡œ ë°›ì„ ìˆ˜ ìˆìŒ
- ControllerOptionsëŠ” ScopeOptionsë¥¼ ìƒì†

```js
export declare function Controller(options: ControllerOptions): ClassDecorator;

export interface ControllerOptions extends ScopeOptions, VersionOptions {
path?: string | string[];
host?: string | RegExp | Array<string | RegExp>;
}

export interface ScopeOptions {
scope?: Scope;
}
```

- ë”°ë¼ì„œ ë‹¤ìŒ ì½”ë“œì™€ ê°™ì´ scope ì†ì„±ì„ ì „ë‹¬ ê°€ëŠ¥

```js
@Controller({
  path: "cats",
  scope: Scope.REQUEST,
})
export class CatsController {}
```

##### ìŠ¤ì½”í”„ ê³„ì¸µ(Scope hierarchy)

- ìŠ¤ì½”í”„ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ì™€ í”„ë¡œë°”ì´ë”ì— ì„ ì–¸í•  ìˆ˜ ìˆëŠ”ë° ë§Œì•½ ì—°ê´€ëœ ì»´í¬ë„ŒíŠ¸ë“¤ì´ ì„œë¡œ ë‹¤ë¥¸ ìŠ¤ì½”í”„ë¥¼ ê°€ì§€ê²Œ ëœë‹¤ë©´ ?

EX> ì˜ˆë¥¼ ë“¤ì–´ CatsController â†’ CatsService â†’ CatsRepository ì™€ ê°™ì€ ì¢…ì†ì„± ê·¸ë˜í”„ë¥¼ ê°€ì§€ê³  ìˆëŠ” ìƒíƒœì—ì„œ CatsServiceëŠ” REQUEST ìŠ¤ì½”í”„ë¥¼ ê°€ì§€ê³ , ë‚˜ë¨¸ì§€ëŠ” ëª¨ë‘ DEFAULT ìŠ¤ì½”í”„ë¥¼ ê°€ì§ˆ ê²½ìš°

- ì´ë•Œ CatsControllerëŠ” CatsServiceì— ì˜ì¡´ì ì´ê¸° ë•Œë¬¸ì— REQUESTë¡œ ë³€ê²½
- í•˜ì§€ë§Œ CatsRepositoryëŠ” CatsServiceì— ì˜ì¡´í•˜ê³  ìˆì§€ ì•Šìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ DEFAULTë¡œ ë‚¨ê²Œ ëŒ
  => ì¦‰, ì¢…ì†ì„±ì„ ê°€ì§„ ì»´í¬ë„ŒíŠ¸ì˜ ìŠ¤ì½”í”„ë¥¼ ë”°ë¼ê°€ê²Œ ë©ë‹ˆë‹¤.
